<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Question Entry</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-firestore-compat.min.js"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-6 max-w-4xl">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Quiz Question Entry</h1>
            <p class="text-gray-600">Paste your formatted question text and save to Firebase</p>
        </div>



        <!-- Question Entry Form -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Question Entry</h2>
            
            <!-- Textarea for question input -->
            <div class="mb-6">
                <label for="questionText" class="block text-sm font-medium text-gray-700 mb-2">
                    Paste Question Text (with options)
                </label>
                <textarea 
                    id="questionText" 
                    rows="8" 
                    class="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                    placeholder="Paste your formatted question text here...

Example:
'In a pipelined processor, if 5 instructions take 9 clock cycles to complete, what is the pipeline speedup compared to a non-pipelined processor?
(A) 1.5
(B) 1.8
(C) 2.0
(D) 2.25'"
                ></textarea>
            </div>

            <!-- Parse Button -->
            <button onclick="parseQuestion()" class="w-full md:w-auto bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition-colors mb-6">
                Parse Question
            </button>

            <!-- Parsed Fields Display -->
            <div id="parsedFields" class="hidden">
                <h3 class="text-lg font-medium text-gray-800 mb-4">Parsed Question Fields</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Subject</label>
                        <select id="subject" onchange="loadUnits()" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="Computer Science & Applications">Computer Science & Applications</option>
                            <option value="Economics">Economics</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Paper</label>
                        <select id="paper" onchange="loadUnits()" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="Paper1">Paper1</option>
                            <option value="Paper2">Paper2</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Unit</label>
                        <select id="unit" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">Loading units...</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Question Number</label>
                        <input type="text" id="qNo" readonly class="w-full p-3 bg-gray-100 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Answer</label>
                        <select id="ans" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">Select Answer</option>
                            <option value="A">A</option>
                            <option value="B">B</option>
                            <option value="C">C</option>
                            <option value="D">D</option>
                        </select>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Question Text</label>
                    <textarea id="question" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Option A</label>
                        <input type="text" id="optionA" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Option B</label>
                        <input type="text" id="optionB" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Option C</label>
                        <input type="text" id="optionC" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Option D</label>
                        <input type="text" id="optionD" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                </div>

                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Explanation</label>
                    <textarea id="exp" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Enter explanation here..."></textarea>
                </div>

                <!-- Save Button -->
                <button onclick="saveQuestion()" class="w-full bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors font-medium">
                    Save to Firebase
                </button>
            </div>

            <!-- Status Messages -->
            <div id="statusMessage" class="mt-4 p-3 rounded-lg hidden"></div>
        </div>
    </div>

    <script>
        let db = null;
        let currentQuestionNumber = 1;

        // Initialize Firebase automatically when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeFirebase();
        });

        // Initialize Firebase
        function initializeFirebase() {
            const firebaseConfig = {
                apiKey: "AIzaSyC3Euw4CyPnMtHnyClV1tVmkNtfIFTXc9I",
                authDomain: "sunilvox-1.firebaseapp.com",
                projectId: "sunilvox-1",
                storageBucket: "sunilvox-1.firebasestorage.app",
                messagingSenderId: "1046912567084",
                appId: "1:1046912567084:web:8a36a701601bfee59fce89",
                measurementId: "G-C1GVJ38N09"
            };

            try {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                
                // Get the next question number and load units
                getNextQuestionNumber();
                loadUnits();
                
            } catch (error) {
                console.error('Firebase initialization failed:', error);
                showStatus('Firebase initialization failed. Please refresh the page.', 'error');
            }
        }

        // Load units from syllabus collection based on subject and paper
        async function loadUnits() {
            if (!db) return;

            const subject = document.getElementById('subject').value;
            const paper = document.getElementById('paper').value;
            const unitSelect = document.getElementById('unit');

            // Clear current options
            unitSelect.innerHTML = '<option value="">Loading units...</option>';

            try {
                const syllabusRef = db.collection('syllabus');
                const query = syllabusRef.where('subject', '==', subject).where('paper', '==', paper);
                const snapshot = await query.get();

                unitSelect.innerHTML = '<option value="">Select Unit</option>';

                if (!snapshot.empty) {
                    const units = [];
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.unit) {
                            units.push(data.unit);
                        }
                    });

                    // Remove duplicates and sort
                    const uniqueUnits = [...new Set(units)].sort();
                    
                    uniqueUnits.forEach(unit => {
                        const option = document.createElement('option');
                        option.value = unit;
                        option.textContent = unit;
                        unitSelect.appendChild(option);
                    });
                } else {
                    unitSelect.innerHTML = '<option value="">No units found</option>';
                }
            } catch (error) {
                console.error('Error loading units:', error);
                unitSelect.innerHTML = '<option value="">Error loading units</option>';
            }
        }

        // Get next question number from Firebase
        async function getNextQuestionNumber() {
            try {
                const questionsRef = db.collection('questions');
                const snapshot = await questionsRef.orderBy('qNo', 'desc').limit(1).get();
                
                if (!snapshot.empty) {
                    const lastDoc = snapshot.docs[0];
                    const lastQNo = parseInt(lastDoc.data().qNo) || 0;
                    currentQuestionNumber = lastQNo + 1;
                } else {
                    currentQuestionNumber = 1;
                }
                
                document.getElementById('qNo').value = currentQuestionNumber.toString();
            } catch (error) {
                console.error('Error getting next question number:', error);
                currentQuestionNumber = 1;
                document.getElementById('qNo').value = currentQuestionNumber.toString();
            }
        }

      // Parse question text
async function parseQuestion() {
    const text = document.getElementById('questionText').value.trim();
    
    if (!text) {
        showStatus('Please enter question text', 'error');
        return;
    }

    if (!db) {
        showStatus('Firebase not initialized. Please refresh the page.', 'error');
        return;
    }

    try {
        // Remove quotes if present
        const cleanText = text.replace(/^['"]|['"]$/g, '');
        
        // Split by lines and filter empty lines
        const lines = cleanText.split('\n').map(line => line.trim()).filter(line => line);
        
        // Find question text (everything before first option)
        let questionText = '';
        let optionLines = [];
        let foundFirstOption = false;
        
        for (let line of lines) {
            if (/^\([A-D]\)/.test(line)) {
                foundFirstOption = true;
                optionLines.push(line);
            } else if (!foundFirstOption) {
                questionText += (questionText ? ' ' : '') + line;
            }
        }
        
        // Parse options
        const options = { A: '', B: '', C: '', D: '' };
        
        for (let line of optionLines) {
            const match = line.match(/^\(([A-D])\)\s*(.+)$/);
            if (match) {
                options[match[1]] = match[2].trim();
            }
        }

        // Check if question already exists in Firebase
        const querySnapshot = await db.collection('questions')
            .where('question', '==', questionText.trim())
            .get();

        if (!querySnapshot.empty) {
            const existingDoc = querySnapshot.docs[0];
            const existingData = existingDoc.data();
            showStatus(`This question already exists! (Question #${existingData.qNo} - Subject: ${existingData.subject}, Paper: ${existingData.paper}, Unit: ${existingData.unit})`, 'error');
            return;
        }
        
        // Populate fields
        document.getElementById('question').value = questionText;
        document.getElementById('optionA').value = options.A;
        document.getElementById('optionB').value = options.B;
        document.getElementById('optionC').value = options.C;
        document.getElementById('optionD').value = options.D;
        
        // Show parsed fields
        document.getElementById('parsedFields').classList.remove('hidden');
        
        showStatus('Question parsed successfully!', 'success');
        
    } catch (error) {
        showStatus('Error parsing question: ' + error.message, 'error');
    }
}

        // Save question to Firebase
        async function saveQuestion() {
            if (!db) {
                showStatus('Firebase not initialized. Please refresh the page.', 'error');
                return;
            }

            const questionData = {
                qNo: document.getElementById('qNo').value,
                subject: document.getElementById('subject').value,
                paper: document.getElementById('paper').value,
                unit: document.getElementById('unit').value,
                question: document.getElementById('question').value.trim(),
                optionA: document.getElementById('optionA').value.trim(),
                optionB: document.getElementById('optionB').value.trim(),
                optionC: document.getElementById('optionC').value.trim(),
                optionD: document.getElementById('optionD').value.trim(),
                ans: document.getElementById('ans').value,
                exp: document.getElementById('exp').value.trim()
            };

            // Validation
            if (!questionData.subject) {
                showStatus('Subject is required', 'error');
                return;
            }

            if (!questionData.paper) {
                showStatus('Paper is required', 'error');
                return;
            }

        /*    if (!questionData.unit) {
                showStatus('Unit is required', 'error');
                return;
            }
*/
            if (!questionData.question) {
                showStatus('Question text is required', 'error');
                return;
            }

            if (!questionData.optionA || !questionData.optionB || !questionData.optionC || !questionData.optionD) {
                showStatus('All options are required', 'error');
                return;
            }

            if (!questionData.ans) {
                showStatus('Please select the correct answer', 'error');
                return;
            }

            try {
                // Save with document ID same as question number
                await db.collection('questions').doc(questionData.qNo).set(questionData);
                
                showStatus('Question saved successfully!', 'success');
                
                // Clear form and prepare for next question
                clearForm();
                currentQuestionNumber++;
                document.getElementById('qNo').value = currentQuestionNumber.toString();
                
            } catch (error) {
                showStatus('Error saving question: ' + error.message, 'error');
            }
        }

        // Clear form
        function clearForm() {
            document.getElementById('questionText').value = '';
            document.getElementById('question').value = '';
            document.getElementById('optionA').value = '';
            document.getElementById('optionB').value = '';
            document.getElementById('optionC').value = '';
            document.getElementById('optionD').value = '';
            document.getElementById('ans').value = '';
            document.getElementById('exp').value = '';
            document.getElementById('parsedFields').classList.add('hidden');
        }

        // Show status message
        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = `mt-4 p-3 rounded-lg ${type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`;
            statusDiv.classList.remove('hidden');
            
            setTimeout(() => {
                statusDiv.classList.add('hidden');
            }, 5000);
        }

        // Sample data for testing
        document.getElementById('questionText').value = `'In a pipelined processor, if 5 instructions take 9 clock cycles to complete, what is the pipeline speedup compared to a non-pipelined processor?
(A) 1.5
(B) 1.8
(C) 2.0
(D) 2.25'`;
    </script>
</body>
</html>